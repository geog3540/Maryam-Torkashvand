<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">-->
  <meta name="viewport" content="width=1200, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--bootstrap loading-->
  <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">-->

  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <!-- Custom styles for this template -->
  <link href="css/3-col-portfolio.css" rel="stylesheet">

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

<!-- Latest compiled JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <!--jquery library for adding description boxes for introductions-->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!--loading d3-->
  <script src="https://d3js.org/d3.v6.min.js"></script>

  <title>migrationstructures</title>

  <style>

  /*some basic styling*/
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    margin-left: 0;
  }

  /*style for header and navigation*/
  .header {
    background-color: #14365D;
    padding: 1rem;
  }
  .header h1 {
    color: #fff;
    margin: 0;
    font-size: 1.5rem;
  }
  .nav {
    display: flex;
    justify-content: flex-end;
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
  .nav li {
    display: inline-block;
    margin-left: 1rem;
  }
  .nav a {
    color: #fff;
    text-decoration: none;
  }

  .navbar {
    display: flex;
    justify-content: space-around;
    background-color: #333;
    padding: 10px;
  }

  .navbar a {
    color: white;
    text-decoration: none;
    padding: 8px 16px;
  }

  .navbar a:hover {
    background-color: #ddd;
    color: black;
  }

  .description-box {
      display: none;
      margin-top: 10px;
      padding: 10px;
      background-color: #f2f2f2;
      border: 1px solid #ccc;
      font-size: 14px;
      text-align: justify;
    }

    .description-box p {
      margin: 5px;
    }

    .container p{
      margin: 5px;
    }

  /* Style for project description */
  .description {
    background-color: #f5f5f5;
    padding: 1rem;
    margin-bottom: 1rem;
  }

  /*containers style*/
  .container {
    padding: 0;
  }

  .map-grid-container {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
  }

  .map-fixed-size {
    zoom: 1;
  }

  /*defining style and size for map containers, so we can have map grid*/
  .map-container {
    position: relative;
    display: inline-block;
    /*margin: 20px 10px;*/
    width: calc(45% - 20px); /* 50% width for 2 columns, minus 20px for margin */
    border: 1px solid black;
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
  }

  .map-title{
    font-weight: bold;
    text-align: center;
    margin-bottom: 2px;
    padding: 10px;
  }
  /*style for compre drop down bottom*/
  .compare-btn {
    position: absolute;
    bottom: 5px;
    right: 30px;
    z-index: 10;
  }
  /*style for the text under each map for descriptions*/
  .map-description-container {
    margin-top:10px; /* Added margin-top to create the gap */
    padding: 0;
    width: 100%;
    font-size: 14px;
    text-align: center;
  }

  .map-description {
    margin-bottom: 10px;
  }


  /* style for footer */
  .footer {
    background-color: #14365D;
    color: #fff;
    padding: 1rem;
    text-align: center;
    margin-top: 1rem;
  }
  </style>
</head>



<!--Defining the navigation, header and description, ...-->
<body>
  <div class="container custom-container">
  <header class="header">
    <h1>Migration Structures in the United States (1870-1920)</h1>
    <ul class="nav">
      <li><a href="../index.html"target="_blank">Portfolio</a></li>
      <li><a href="../shortbio.html"target="_blank">About</a></li>
      <li><a href="../files/Torkashvand_CV_March-2023.pdf"target="_blank">My C.V.</a></li>
      <li><a href="mailto:maryam-torkashvand@uiowa.edu">Contact</a></li>
    </ul>
  </header>


  <div class="navbar">
    <a href="#" id="intro">Introduction</a>
    <a href="#" id ="goal">Goals</a>
    <a href="#" id = "data">Data</a>
    <a href="#"id= "usability">Usability survey</a>
  </div>

  <div class="description-box" id="intro-description">
    <h4>Introduction</h4>
    <p>As an example of geographical regionalization, identifying migration regions is one of the growing areas of study among geographers. Ideally, a system of migration regions can be defined as follows:</p>
    <p>    "Groups of administrative units with the maximum internal interaction and a minimum flow across the migration-defining boundaries (Ng, R.C.Y., 1969)."</p>
    <p>The structures and processes responsible for the formation of regions are not randomly dispersed across the Earth's surface (Duckham et al. 2003). Distance plays a significant role in migration structures, especially on the national scale. However, other factors such as kinship or friendship ties and historical events like Cold War and the Gold rush in the United States also have a significant impact on forming the migration structure in the US over the settlement period. During the nineteenth century, the United States experienced a significant degree of population mobility, as individuals often traveled extensive distances due to the westward progression of European settlement.</p>
    <p>To better understand the structure of migration and its evolution over time, we can map migration regions on a large spatiotemporal scale. Studying migration regions through time can tell us how people settled in the United States, what was the structure of flows, and what they can tell us about current social and cultural structures.</p>
  </div>

  <div class="description-box" id="goal-description">
    <h4>Project Goals</h4>
    <p>The aim of this project is to obtain and visualize the migration regions using migration networks from the large multi-generational Family tree dataset. For this purpose, I plan to use two network community detection algorithm, Louvain and Leiden. By extracting migration regions over time, we can understand the structure of migrations and mobility of people between 1850 and 1920, which occurred between geographically distant places because of their strong migration ties among each other. Moreover, Mapping long-term changes in interstate historical migration flows in the U.S. can tell us about the present cultural and social structures in the country.</p>
    <p>I aimed to create a straightforward visualization tool to cater to anyone involved in regionalization studies, enabling effortless map imports and offering comparative visualizations with both visual and statistical analysis options.</p>
  </div>

  <div class="description-box" id="data-description">
    <h4>Data</h4>
    <p>For mapping migration regions, I use extracted migrations networks from the family tree dataset, which has been developed by Koylu et al. (2021). The family tree is a network of family members stretching over many generations, containing approximately 40 million individuals. Migration networks are those networks in which the nodes are the states of the US, and edges are the volume of families who moved between states. Using migration networks, including origin, destination, and the volume of families who migrate between states in different intervals and applying the louvain and Leiden algorithm, the regions (communities) for each network can be obtained.</p>
  </div>

  <div class="description-box" id="usability-description">
    <h4>Usability survey</h4>
    <p>By participating in the usability survey, you will help me understand the strengths and limitations of regionalization mapping and representation techniques. Refer to the 'How to use the maps' section for guidance on utilizing the maps. For further information about the project, its objectives, and the data, please explore the preceding sections.</p>
    <li><a href="https://forms.gle/892KRyKfTYCp7TLD7" target="_blank">click here to start the survey</a></li>
  </div>

  <!-- Page Content -->
  <div class="container my-5">
        <div class="card">
          <div class="card-header">
            <h4>How to use the maps</h4>
          </div>
          <div class="card-body">
            <li>The colors on the maps represent states with strong migration connections. States with the same color have more migration flows between them, both in terms of numbers and magnitude. Each color represents a "migration region". </li>
            <li>The goal is to observe changes in migration region structures over time and compare two methods used to identify these regions.</p>
            <li>The first row of maps shows regions found using Method #1 (<a href="https://doi.org/10.1088/1742-5468/2008/10/P10008" target="_blank">Louvain community detection algorithm</a>), while the second row displays regions from Method #2 (<a href="https://doi.org/10.1038/s41598-019-41695-z" target="_blank">Leiden community detection algorithm</a>).</li>
            <li>You can compare maps using a feature that calculates their <a href= "https://en.wikipedia.org/wiki/Similarity_(network_science)#:~:text=Similarity%20in%20network%20analysis%20occurs,automorphic%20equivalence%2C%20and%20regular%20equivalence." target= "_blank"> similarity </a>, shown in a pop-up window. If the similarity appears as "undefined," try reversing the comparison (e.g., if Map 1 with Map 2 is undefined, then attempt Map 2 with Map 1).</li>
            <li>Hover over in the maps to see each state and its assigned region number </li>
              <li>
                <a href="https://doi.org/10.1088/1742-5468/2008/10/P10008" target="_blank">Modularity</a> is a measure of the structure of networks or graphs which measures the strength of division of a network into groups.
              </li>
          </div>
        </div>
      </div>
    </div>



  <!--Map Grid: Maps are shown here-->
  <div class = "container">
    <div clas = "map-grid-container map-fixed-size">
      <div class="row">
        <div id="mapGrid" class="row">
          <div id="info"></div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    Copyright &copy; Maryam Torkashvand 2023
  </footer>

<!--Definnig functions and variables inside script. everything we want to append pr all functions are defined inside script-->
<script>

//efining the descriptions for introduction and goals
$('#intro').on('click', function (event) {
  event.preventDefault();
  const descriptionBox = $('#intro-description');
  descriptionBox.toggle();
});

$('#goal').on('click', function (event) {
  event.preventDefault();
  const descriptionBox = $('#goal-description');
  descriptionBox.toggle();
});

$('#data').on('click', function (event) {
  event.preventDefault();
  const descriptionBox = $('#data-description');
  descriptionBox.toggle();
});

$('#usability').on('click', function (event) {
  event.preventDefault();
  const descriptionBox = $('#usability-description');
  descriptionBox.toggle();
});

//a function that extracts communities from geojson files and make an array
//each element of this array is a community of each maps
//we use this array to calculate PaircountSimilarity later
//the name of community attribute (the name of the column that shows the partitions) must be same in all maps
//So for each map in each year and each method we need to have one geojson file with a column name "partition"
//!!"liedenpart" should be updated!!
async function getCommunitiesFromGeoJSON(filePaths) {
  const communities = [];

  for (const filePath of filePaths) {
    const response = await fetch(filePath);
    const geoJsonData = await response.json();
    const community = geoJsonData.features.map(feature => feature.properties.partition);
    communities.push(community);
  }

  return communities;
}

//this function calculate the paircointing similarity between maps
function pairCountingSimilarity(communities1, communities2) {
  //if (communities1.length !== communities2.length) {
  //  throw new Error("Input arrays must have the same length");
  //}

  //initialize the variables
  let matches = 0;
  let totalPairs = 0;

  //define the unique pairs of nodes (0,1),(0,2), ... (n-1,n)
  for (let i = 0; i < communities1.length; i++) {
    for (let j = i + 1; j < communities1.length; j++) {
      totalPairs++;

      //chech whether those pairs that are in a same community in network 1 also are the same community in network 2
      //if true, add 1 to the match variable
      if (communities1[i] === communities1[j] && communities2[i] === communities2[j]) {
        matches++;
      }
    }
  }
  return matches / totalPairs;
}

let activeState = null;

  // this function draw all maps in a specific size and put them in the grid
  function drawMap(mapId, geoJsonData, partitionAttribute, colorScale, ID) {
    const width = 400;
    const height = 250;
    const projection = d3.geoAlbersUsa().scale(500).translate([width / 2, height / 2]);
    const path = d3.geoPath().projection(projection);
    // add each map
    const svg = d3.select("#" + mapId)
    .append("svg")
    .attr("width", width)
    .attr("height", height);
    // fill the map based on partitionAttribute
    //also look at the table of maps and extract id and partition for hover over function
    svg.selectAll("path")
    .data(geoJsonData.features)
    .join("path")
    .attr("d", path)
    .attr("fill", d => colorScale(d.properties[partitionAttribute]))
    .attr("stroke", "gray")
    .attr("stroke-width", 0.5)
    .attr("class", d => `mapPath state-${d.properties[ID].replace(/\s+/g, '-')}`)
    .on("mouseover", function (event, d) {
      activeState = d.properties[ID];
      d3.selectAll(".state-" + activeState.replace(/\s+/g, '-'))
      .attr("stroke", "black")
      .style("stroke-width", "3")
      .append("title")
      .text(`State: ${d.properties[ID]}, Region: ${d.properties[partitionAttribute]}`);
    })
    .on("mouseout", function () {
      d3.selectAll(".state-" + activeState.replace(/\s+/g, '-'))
      .attr("stroke", "gray")
      .style("stroke-width", "0.5")
      .selectAll("title")
      .remove();
      activeState = null;
    });

    // Draw the legend
    const legend = svg.append("g")
        .attr("transform", `translate(${width - 400}, ${height - 50})`);

    const legendData = colorScale.domain().map(value => ({
        value,
        color: colorScale(value),
    }))

    }

    // Define a fixed domain with the attribute values you want to have consistent colors
    const fixedDomain = ["0", "1", "2", "3", "4"];

    // Create a color scale with a fixed domain and a range of colors
    const colorScale = d3.scaleOrdinal()
    .domain(fixedDomain)
    //.range(["#fbb4ae", "#b3cde3", "#decbe4", "#b3e2cd", "#f1e2cc"]);
    .range(["#8dd3c7", "#bebada", "#fb8072", "#80b1d3", "#fdb462"]);

  //definning colorscheme
  //const colorScale = d3.scaleOrdinal(["#fbb4ae","#b3cde3","#decbe4","#b3e2cd","#f1e2cc"]);

  // List of GeoJSON file paths. this list store the maps geojson files
  const mapFiles = [
    "geojsonfiles/louvainnew1870-80.geojson",
    "geojsonfiles/louvainnew1900-10.geojson",
    "geojsonfiles/louvainnew1910-20.geojson",
    "geojsonfiles/leidennew1870-80.geojson",
    "geojsonfiles/leidennew1900-10.geojson",
    "geojsonfiles/leidennew1910-20.geojson"
  ];

  //initialling a dictionary that stores all similarity values beetween all map pairs
  //So we can call the similarity and show them for the compare values
  //let make the variable global so we can use it outside of the function
  let similarityDictionary = {};

  //this function extract communities from geojson files
  //calculate paircounting similarity
  //and store it in a dictionart and print it on the console
  getCommunitiesFromGeoJSON(mapFiles).then(communities => {
    console.log("Communities array:", communities);
    //initializing dict
    const similarityDict = {};
    //for all communities from files fill the dict by key:index of two maps and value:similarity
    for (let i = 0; i < communities.length; i++) {
      for (let j = i + 1; j < communities.length; j++) {
        const key = `${i+1}-${j+1}`;
        const similarityScore = pairCountingSimilarity(communities[i], communities[j]);
        similarityDict[key] = similarityScore;
      }
    }
    similarityDictionary = similarityDict;
    console.log("Similarity dictionary:", similarityDictionary);
  });

  //this list stores text files that has descriptions for each map
  //like madularity, number of regions and a brief description
  //!!add text files for all maps and name of them must be "description[i]"
  const mapTitles = [
  "Map 1: 1870-1880 <br><span style='font-size: 0.5em;'>Method #1</span>",
  "Map 2: 1900-1910 <br><span style='font-size: 0.5em;'>Method #1</span>",
  "Map 3: 1910-1920 <br><span style='font-size: 0.5em;'>Method #1</span>",
  "Map 4: 1870-1880 <br><span style='font-size: 0.5em;'>Method #2</span>",
  "Map 5: 1900-1910 <br><span style='font-size: 0.5em;'>Method #2</span>",
  "Map 6: 1910-1920 <br><span style='font-size: 0.5em;'>Method #2</span>"
  ];

  const descriptionFiles = [
  "data/description12.txt",
  "data/description21.txt",
  "data/description3.txt",
  "data/description42.txt",
  "data/description41.txt",
  "data/description45.txt"
  ];

  //this code make an access to each mapgrid, so we cam manupulate interval
  //here add description box to each grid
  const mapGrid = document.getElementById("mapGrid");

  //This function read and load the text files and format it to paragraph
  function loadDescription(filename, mapContainer) {
    d3.text(filename).then(function (text) {
      const paragraphs = text.split("\n");
      const descriptionContainer = mapContainer.append("div")
        .attr("class", "map-description-container");
      paragraphs.forEach(function (paragraph) {
        if (paragraph.trim() !== "") {
          mapContainer.append("p")
          .attr("class", "map-description")
          .text(paragraph);
        }
      });
    });
  }
/////////////////////////////////////////////////////////////////////////////////
  //Now definning a foe loop that define attributes for all elemets of each Grid
  //and draw maps, discription, compare bottom in each grid
  for (let i = 0; i < mapFiles.length; i++) {
    const mapId = "map" + i;
    const mapContainer = d3.select("#mapGrid")
    .append("div")
    .attr("class", "col-md-4 map-container");

    mapContainer.append("h3")
    .attr("class", "map-title")
    .html(mapTitles[i]);

    mapContainer.append("div")
    .attr("id", mapId)
    .attr("class", "map");

    // This code creats dropdown bottoms
    const dropdown = mapContainer.append("select")
    .attr("class", "form-control compare-dropdown")

    // for each drop down define options.
    // foe each map the options are all other maps (j !== i)
    for (let j = 0; j < mapFiles.length; j++) {
      if (j !== i) {
        dropdown.append("option")
        .attr("value", j)
        .text("Compare with Map " + (j + 1));
      }
    }

    // definnig the drop down functionality
    //first defining key and value variables from similarity dictionary
    //then define an alert window that shows the similarity between the map and selected option
    dropdown.on("change", function () {
      const selectedMapIndex = parseInt(this.value);
      const key = `${i+1}-${selectedMapIndex}`;
      const similarityValue = similarityDictionary[key]
      console.log(`Comparing map ${i+1} with map ${selectedMapIndex + 1}`);
      alert(`Similarity between Map ${i+1} and Map ${selectedMapIndex + 1}: ${similarityValue.toFixed(4)}`);
    });

    //Drawing the maps one by one based on partition attribute name
    //!!change the name of attribute!!//
    d3.json(mapFiles[i]).then(geoJsonData => {
      const partitionAttribute = "partition";
      const ID = "STATE_NAME"
      drawMap(mapId, geoJsonData, partitionAttribute, colorScale, ID);
      //append description for each map
      const descriptionFilename = descriptionFiles[i];
      loadDescription(descriptionFilename, mapContainer);
      });
    }

</script>
</div>
</body>
</html>
